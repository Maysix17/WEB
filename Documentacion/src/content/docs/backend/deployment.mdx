---
title: Despliegue y Configuraci√≥n
description: Gu√≠a completa para desplegar y configurar la API de AgroTic
---

# Despliegue Backend

npm run docker:dev-  Construye los contenedores y los levanta, eliminando contenedores hu√©rfanos.

npm run docker: g- Levanta los contenedores ya construidos sin volver a compilar.

npm run docker:r- Corre las migraciones dentro del contenedor Docker. 

npm run docker:seed- Inserta datos iniciales en la base de datos dentro de Docker.

# Despliegue Frontend y Astro

npm install- Instala las librer√≠as que el frontend necesita para funcionar.

npm run dev- Arranca el proyecto en modo desarrollo para verlo en el navegador.

# Documentaci√≥n Completa ‚Äì ESP32 + Sensores + MQTT (Arduino IDE)
üìå 1. Requisitos previos
üîß Librer√≠as necesarias (versiones recomendadas)

Inst√°lalas desde el Administrador de Librer√≠as del Arduino IDE:

Librer√≠a	Versi√≥n
PubSubClient	2.9
DHT sensor library	1.4.7
Adafruit Unified Sensor	1.1.15
WiFi (incluida en ESP32 Core)	Core 3.0.0 o superior
math.h	Incluida por defecto
üì° 2. Configuraci√≥n de credenciales WiFi

En el c√≥digo, edita:

const char* ssid = "TU_WIFI";
const char* password = "TU_PASSWORD";


Reemplaza:

TU_WIFI ‚Üí nombre de tu red

TU_PASSWORD ‚Üí contrase√±a del WiFi

üîå 3. Configuraci√≥n del broker MQTT

Si usas otro broker, modifica:

const char* mqtt_server = "test.mosquitto.org";
const int mqtt_port = 1883;


Puedes cambiar:

mqtt_server ‚Üí IP o dominio del broker

mqtt_port ‚Üí puerto (1883 por defecto)

üß© 4. C√≥digo completo para ESP32

üìé P√©galo tal cual en tu Arduino IDE.

[EL C√ìDIGO COMPLETO QUEDA IGUAL ‚Äî LO RESPETO EXACTAMENTE COMO ME LO ENVIASTE]


(Para no hacer este mensaje extremadamente largo, mantuve tu c√≥digo igual. Si quieres que lo formatee con colores para Astro o lo divida en archivos, me dices.)

üìä 5. C√≥mo verificar que los sensores env√≠an datos
‚úÖ 1. Verificar en Arduino IDE (Monitor Serie)

Abre:

Ctrl + Shift + M

O desde men√∫: Herramientas ‚Üí Monitor Serie

Configura a 115200 baudios

Deber√≠as ver valores similares a:

Temperatura: 24.5 ¬∞C
Humedad Ambiente: 60 %
Gas MQ-4 ppm: 140.20
Luz: 30 %
Humedad Suelo: 45 %
Bomba: Apagada

üì° 2. Verificar en MQTT Explorer

Suscr√≠bete a estos t√≥picos:

agrotic/sensores/temperatura
agrotic/sensores/humedad
agrotic/sensores/gas
agrotic/sensores/luz
agrotic/sensores/humedad_suelo
agrotic/actuadores/bomba


Si recibes mensajes ‚Üí el sistema est√° funcionando correctamente.

üñ•Ô∏è 6. Uso del Monitor Serie

El Monitor Serie permite ver:

üì° Estado del WiFi

üîå Estado del broker MQTT

üìä Valores en tiempo real de sensores:

Temperatura

Humedad ambiente

PPM del MQ-4

Luz (LDR)

Humedad del suelo

üõ†Ô∏è Mensajes de depuraci√≥n

## ESP32

El sistema est√° construido utilizando un ESP32 montado sobre una placa de expansi√≥n (shield) que facilita la conexi√≥n de sensores y actuadores. A este m√≥dulo se conectan varios sensores ambientales y un rel√© encargado de activar la bomba de agua. Los sensores utilizados y los pines configurados en el ESP32 son los siguientes:

Sensor DHT11 (temperatura y humedad ambiental) conectado al pin digital 2 (DHTPIN) del ESP32.

Sensor de gas MQ-4 conectado a la entrada anal√≥gica A1 (MQ4_PIN) del shield/ESP32.

Sensor LDR (sensor de luz) conectado mediante un divisor de voltaje a la entrada anal√≥gica A4 (LDR_PIN).

Sensor de humedad del suelo conectado a la entrada anal√≥gica A6 (HUMEDAD_PIN).

M√≥dulo rel√© conectado al pin digital 6 (RELE_PIN), desde donde se controla su activaci√≥n.

La bomba de agua se alimenta desde una bater√≠a externa, y su energ√≠a se controla a trav√©s del rel√©. La conexi√≥n se realiza de la siguiente manera:

El positivo de la bater√≠a (+) se conecta al terminal COM del rel√©.

El terminal NO (normalmente abierto) del rel√© se conecta al positivo de la bomba.

El negativo de la bater√≠a (‚Äì) se conecta directamente al negativo de la bomba.

Cuando el ESP32 env√≠a una se√±al al rel√© desde el pin 6, este cierra el contacto entre COM y NO, permitiendo que la corriente de la bater√≠a llegue a la bomba y esta se active. Cuando la se√±al se apaga, el rel√© abre el circuito y la bomba deja de funcionar.

## Variables de Entorno

### Archivo .env

```env
# Base de datos
DB_HOST=localhost
DB_PORT=5432
DB_USERNAME=postgres
DB_PASSWORD=your_password
DB_DATABASE=agrotic

# JWT
JWT_SECRET=your_super_secret_jwt_key_here
JWT_EXPIRATION_TIME=15m
JWT_REFRESH_SECRET=your_super_secret_refresh_key_here
JWT_REFRESH_EXPIRATION_TIME=30d

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# Correo electr√≥nico
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USER=your-email@gmail.com
MAIL_PASSWORD=your-app-password
MAIL_FROM=noreply@agrotic.com

# Aplicaci√≥n
NODE_ENV=production
PORT=3001
FRONTEND_URL=http://localhost:3000

# Archivos
UPLOADS_DEST=./uploads
```

### Archivo .env.example

```env
# Copiar este archivo como .env y completar con valores reales

# Base de datos
DB_HOST=
DB_PORT=5432
DB_USERNAME=
DB_PASSWORD=
DB_DATABASE=agrotic

# JWT - Generar claves seguras
JWT_SECRET=
JWT_EXPIRATION_TIME=15m
JWT_REFRESH_SECRET=
JWT_REFRESH_EXPIRATION_TIME=30d

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379

# Correo electr√≥nico
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USER=
MAIL_PASSWORD=
MAIL_FROM=noreply@agrotic.com

# Aplicaci√≥n
NODE_ENV=development
PORT=3001
FRONTEND_URL=http://localhost:3000

# Archivos
UPLOADS_DEST=./uploads
```

## Docker

### Dockerfile

```dockerfile
FROM node:20-alpine

# Crear directorio de la aplicaci√≥n
WORKDIR /app

# Copiar archivos de dependencias
COPY package*.json ./

# Instalar dependencias
RUN npm ci --only=production

# Copiar c√≥digo fuente
COPY . .

# Construir la aplicaci√≥n
RUN npm run build

# Crear usuario no root
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nestjs -u 1001

# Cambiar propietario de archivos
USER nestjs

# Exponer puerto
EXPOSE 3001

# Comando de inicio
CMD ["npm", "run", "start:prod"]
```

### docker-compose.yml

```yaml
version: '3.8'

services:
  api:
    build: .
    ports:
      - "3001:3001"
    environment:
      - DB_HOST=db
      - REDIS_HOST=redis
    depends_on:
      - db
      - redis
    volumes:
      - ./uploads:/app/uploads
    networks:
      - agrotic-network

  db:
    image: postgres:16
    environment:
      - POSTGRES_DB=agrotic
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=your_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - agrotic-network

  redis:
    image: redis:8-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - agrotic-network

volumes:
  postgres_data:
  redis_data:

networks:
  agrotic-network:
    driver: bridge
```

### Docker Compose para desarrollo

```yaml
version: '3.8'

services:
  api:
    build: .
    ports:
      - "3001:3001"
    volumes:
      - .:/app
      - /app/node_modules
    environment:
      - DB_HOST=db
      - REDIS_HOST=redis
    depends_on:
      - db
      - redis
    command: npm run start:dev
    networks:
      - agrotic-dev

  db:
    image: postgres:16
    environment:
      - POSTGRES_DB=agrotic
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=dev_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_dev:/var/lib/postgresql/data
    networks:
      - agrotic-dev

  redis:
    image: redis:8-alpine
    ports:
      - "6379:6379"
    networks:
      - agrotic-dev

volumes:
  postgres_dev:

networks:
  agrotic-dev:
    driver: bridge
```

## Configuraci√≥n de Base de Datos

### PostgreSQL

#### Crear base de datos

```sql
-- Crear base de datos
CREATE DATABASE agrotic;

-- Crear usuario
CREATE USER agrotic_user WITH PASSWORD 'your_password';

-- Otorgar permisos
GRANT ALL PRIVILEGES ON DATABASE agrotic TO agrotic_user;
```

#### Configuraci√≥n de conexi√≥n

```typescript
// data-source.ts
import { DataSource } from 'typeorm';

export const AppDataSource = new DataSource({
  type: 'postgres',
  host: process.env.DB_HOST || 'localhost',
  port: parseInt(process.env.DB_PORT || '5432'),
  username: process.env.DB_USERNAME || 'postgres',
  password: process.env.DB_PASSWORD,
  database: process.env.DB_DATABASE || 'agrotic',
  entities: [__dirname + '/**/*.entity{.ts,.js}'],
  migrations: [__dirname + '/migrations/*{.ts,.js}'],
  migrationsRun: false,
  logging: process.env.NODE_ENV === 'development',
  synchronize: false, // Nunca usar en producci√≥n
});
```

### Redis

#### Configuraci√≥n b√°sica

```typescript
// En app.module.ts
CacheModule.registerAsync({
  isGlobal: true,
  imports: [ConfigModule],
  inject: [ConfigService],
  useFactory: async (configService: ConfigService) => ({
    store: await redisStore({
      socket: {
        host: configService.get<string>('REDIS_HOST'),
        port: parseInt(configService.get<string>('REDIS_PORT') || '6379'),
      },
    }),
  }),
}),
```

## Configuraci√≥n de Correo Electr√≥nico

### Gmail SMTP

```typescript
// app.module.ts
MailerModule.forRootAsync({
  imports: [ConfigModule],
  inject: [ConfigService],
  useFactory: (configService: ConfigService) => ({
    transport: {
      host: configService.get<string>('MAIL_HOST'),
      port: configService.get<number>('MAIL_PORT'),
      secure: true,
      auth: {
        user: configService.get<string>('MAIL_USER'),
        pass: configService.get<string>('MAIL_PASSWORD'),
      },
    },
    defaults: {
      from: `"AgroTic" <${configService.get<string>('MAIL_FROM')}>`,
    },
  }),
}),
```

### Plantillas de correo

```typescript
// auth.service.ts
async sendPasswordResetEmail(email: string, token: string) {
  const resetUrl = `${this.configService.get('FRONTEND_URL')}/reset-password?token=${token}`;

  await this.mailerService.sendMail({
    to: email,
    subject: 'Restablecimiento de contrase√±a - AgroTic',
    template: 'reset-password',
    context: {
      resetUrl,
      userEmail: email,
    },
  });
}
```

## Configuraci√≥n de Archivos

### Multer para uploads

```typescript
// En m√≥dulos que manejan archivos
@UseInterceptors(
  FileInterceptor('file', {
    storage: diskStorage({
      destination: './uploads',
      filename: (req, file, cb) => {
        const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1e9);
        cb(null, uniqueSuffix + extname(file.originalname));
      },
    }),
    limits: {
      fileSize: 5 * 1024 * 1024, // 5MB
    },
  }),
)
```

### Servir archivos est√°ticos

```typescript
// main.ts
app.useStaticAssets(join(__dirname, '..', 'uploads'), {
  prefix: '/uploads/',
});
```

## Migraciones de Base de Datos

### Ejecutar migraciones

```bash
# Desarrollo
npm run migration:run

# Docker
docker-compose exec api npm run migration:run
```

### Crear nueva migraci√≥n

```bash
npm run migration:create src/migrations/NewMigration
```

### Revertir migraci√≥n

```bash
npm run migration:revert
```

## Seeds de Datos

### Ejecutar seeds

```bash
# Desarrollo
npm run seed:dev

# Producci√≥n
npm run seed:prod

# Docker
docker-compose exec api npm run seed:dev
```

## Configuraci√≥n de Producci√≥n

### PM2

#### package.json scripts

```json
{
  "scripts": {
    "start:prod": "node dist/main",
    "pm2:start": "pm2 start ecosystem.config.js",
    "pm2:stop": "pm2 stop ecosystem.config.js",
    "pm2:restart": "pm2 restart ecosystem.config.js"
  }
}
```

#### ecosystem.config.js

```javascript
module.exports = {
  apps: [{
    name: 'agrotic-api',
    script: 'dist/main.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3001,
    },
    error_file: './logs/err.log',
    out_file: './logs/out.log',
    log_file: './logs/combined.log',
    time: true,
  }],
};
```

### Nginx como Proxy Reverso

```nginx
# /etc/nginx/sites-available/agrotic-api
server {
    listen 80;
    server_name api.agrotic.com;

    location / {
        proxy_pass http://localhost:3001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # Archivos est√°ticos
    location /uploads/ {
        alias /var/www/agrotic/uploads/;
        expires 30d;
    }
}
```

### SSL con Let's Encrypt

```bash
# Instalar certbot
sudo apt install certbot python3-certbot-nginx

# Obtener certificado
sudo certbot --nginx -d api.agrotic.com
```

## Monitoreo y Logs

### Winston para logging

```typescript
// logger.service.ts
import * as winston from 'winston';

@Injectable()
export class LoggerService {
  private logger: winston.Logger;

  constructor() {
    this.logger = winston.createLogger({
      level: process.env.LOG_LEVEL || 'info',
      format: winston.format.combine(
        winston.format.timestamp(),
        winston.format.errors({ stack: true }),
        winston.format.json(),
      ),
      transports: [
        new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
        new winston.transports.File({ filename: 'logs/combined.log' }),
      ],
    });

    if (process.env.NODE_ENV !== 'production') {
      this.logger.add(new winston.transports.Console({
        format: winston.format.simple(),
      }));
    }
  }

  log(message: string, context?: string) {
    this.logger.info(message, { context });
  }

  error(message: string, trace?: string, context?: string) {
    this.logger.error(message, { trace, context });
  }
}
```

## Variables de Entorno por Entorno

### Desarrollo

```env
NODE_ENV=development
LOG_LEVEL=debug
DB_HOST=localhost
REDIS_HOST=localhost
```

### Staging

```env
NODE_ENV=staging
LOG_LEVEL=info
DB_HOST=staging-db.example.com
REDIS_HOST=staging-redis.example.com
```

### Producci√≥n

```env
NODE_ENV=production
LOG_LEVEL=warn
DB_HOST=prod-db.example.com
REDIS_HOST=prod-redis.example.com
FRONTEND_URL=https://agrotic.com
```

## Checklist de Despliegue

### Pre-despliegue
- [ ] Variables de entorno configuradas
- [ ] Base de datos creada y migrada
- [ ] Redis configurado
- [ ] Correo electr√≥nico configurado
- [ ] Directorio de uploads creado
- [ ] Certificados SSL generados

### Despliegue
- [ ] C√≥digo construido
- [ ] PM2 configurado
- [ ] Nginx configurado
- [ ] Firewall configurado
- [ ] Monitoreo configurado

### Post-despliegue
- [ ] Endpoints funcionando
- [ ] Base de datos conectada
- [ ] Archivos subidos correctamente
- [ ] Logs funcionando
- [ ] Backup configurado

## Troubleshooting

### Problemas comunes

#### Error de conexi√≥n a base de datos
```bash
# Verificar conexi√≥n
psql -h localhost -U postgres -d agrotic

# Verificar variables de entorno
echo $DB_HOST $DB_PORT $DB_USERNAME
```

#### Error de Redis
```bash
# Verificar conexi√≥n
redis-cli ping

# Verificar configuraci√≥n
redis-cli config get maxmemory
```

#### Error de uploads
```bash
# Verificar permisos
ls -la uploads/

# Verificar espacio en disco
df -h
```

#### Error de CORS
```typescript
// Verificar configuraci√≥n en main.ts
app.enableCors({
  origin: process.env.FRONTEND_URL,
  credentials: true,
});
```

## Backup y Recuperaci√≥n

### Backup autom√°tico

```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups"

# Backup de base de datos
pg_dump -h $DB_HOST -U $DB_USERNAME $DB_DATABASE > $BACKUP_DIR/db_$DATE.sql

# Backup de archivos
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /app/uploads

# Limpiar backups antiguos (mantener 30 d√≠as)
find $BACKUP_DIR -name "db_*.sql" -mtime +30 -delete
find $BACKUP_DIR -name "uploads_*.tar.gz" -mtime +30 -delete
```

### Configurar cron

```bash
# Editar crontab
crontab -e

# Agregar l√≠nea para backup diario a las 2 AM
0 2 * * * /path/to/backup.sh
```

## Escalabilidad

### Configuraci√≥n de PM2 para m√∫ltiples instancias

```javascript
// ecosystem.config.js
module.exports = {
  apps: [{
    name: 'agrotic-api',
    script: 'dist/main.js',
    instances: 'max', // Una instancia por CPU
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3001,
    },
  }],
};
```

### Load Balancer con Nginx

```nginx
upstream api_backend {
    server localhost:3001;
    server localhost:3002;
    server localhost:3003;
}

server {
    listen 80;
    server_name api.agrotic.com;

    location / {
        proxy_pass http://api_backend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}